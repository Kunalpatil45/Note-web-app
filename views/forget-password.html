<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forgot Password with OTP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .password-toggle {
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .password-toggle:hover {
      color: #3b82f6;
    }
    .input-field:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
  <div id="alert-container" class="fixed top-4 right-4 w-auto z-50"></div>
  <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
    <h2 class="text-2xl font-semibold text-center mb-6 text-gray-800">
      Forgot Password
    </h2>

    <form id="forgot-form" class="space-y-6" novalidate>
      <!-- Step 1: Email input -->
      <div id="email-section" class="text-left">
        <label
          for="email"
          class="block text-sm font-medium text-gray-700 mb-2"
          >Email Address</label
        >
        <div class="relative">
          <input
            id="email"
            type="email"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500 transition-colors duration-200"
            placeholder="Enter your email to reset password"
          />
          <i class="fas fa-envelope absolute right-3 top-3 text-gray-400"></i>
        </div>
      </div>

      <!-- Step 2: OTP input (hidden initially) -->
      <div id="otp-section" class="text-left hidden">
        <label
          for="otp"
          class="block text-sm font-medium text-gray-700 mb-2"
          >Enter OTP</label
        >
        <input
          id="otp"
          type="text"
          maxlength="6"
          pattern="\d{6}"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500 transition-colors duration-200"
          placeholder="6-digit OTP"
        />
        <p class="text-xs text-gray-500 mt-1">
          Please check your email for the OTP.
        </p>
      </div>

      <!-- Step 3: New password inputs (hidden initially) -->
      <div id="password-section" class="space-y-4 hidden">
        <div class="text-left">
          <label
            for="new-password"
            class="block text-sm font-medium text-gray-700 mb-2"
            >New Password</label
          >
          <div class="relative">
            <input
              id="new-password"
              type="password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500 transition-colors duration-200"
              placeholder="Enter new password"
            />
            <i
              class="fas fa-eye-slash password-toggle absolute right-3 top-3 text-gray-400"
              onclick="togglePassword('new-password', this)"
            ></i>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Must be at least 8 characters.
          </p>
        </div>

        <div class="text-left">
          <label
            for="confirm-password"
            class="block text-sm font-medium text-gray-700 mb-2"
            >Confirm New Password</label
          >
          <div class="relative">
            <input
              id="confirm-password"
              type="password"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg input-field focus:outline-none focus:border-blue-500 transition-colors duration-200"
              placeholder="Confirm new password"
            />
            <i
              class="fas fa-eye-slash password-toggle absolute right-3 top-3 text-gray-400"
              onclick="togglePassword('confirm-password', this)"
            ></i>
          </div>
        </div>
      </div>

      <button
        id="submit-btn"
        type="submit"
        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        Send Reset Link
      </button>
    </form>

    <div class="text-center mt-6">
      <a href="/signup" class="text-blue-600 hover:underline font-medium"
        >Back to Sign In</a
      >
    </div>
  </div>

  </body>
  <script>
    function showAlert(message, type = "primary") {
      const container = document.getElementById("alert-container");

      const alert = document.createElement("div");
      alert.className = `alert alert-${type} alert-dismissible fade show shadow-lg mb-2`;
      alert.role = "alert";
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;

      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

  let currentStep = 1; // 1=email, 2=otp, 3=new password
  let userEmail = "";

  const form = document.getElementById("forgot-form");
  const emailSection = document.getElementById("email-section");
  const otpSection = document.getElementById("otp-section");
  const passwordSection = document.getElementById("password-section");
  const submitBtn = document.getElementById("submit-btn");

  function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    }
  }

  // Helper to call backend
  async function postData(url, data) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    return res.json();
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (currentStep === 1) {
      // Step 1: Send email to backend
      const emailInput = document.getElementById("email");
      if (!emailInput.value || !validateEmail(emailInput.value)) {
        showAlert("Please enter a valid email address.", "danger");
        return;
      }

      userEmail = emailInput.value;

      const res = await postData("/api/forgot-password", {
        email: userEmail,
      });

      if (res.success) {
        showAlert("OTP sent to your email.", "success");
        emailSection.classList.add("hidden");
        otpSection.classList.remove("hidden");
        submitBtn.textContent = "Verify OTP";
        currentStep = 2;
      } else {
        showAlert(res.message || "Error sending OTP. Try again.", "danger");
      }
    } 
    else if (currentStep === 2) {
      // Step 2: Verify OTP
      const otpInput = document.getElementById("otp").value;
      const res = await postData("/verify-otp", {
        email: userEmail,
        otp: otpInput,
      });

      if (res.success) {
        showAlert("OTP verified! Please set a new password.", "success");
        otpSection.classList.add("hidden");
        passwordSection.classList.remove("hidden");
        submitBtn.textContent = "Reset Password";
        currentStep = 3;
      } else {
        alert(res.message || "Invalid OTP.");
      }
    } 
    else if (currentStep === 3) {
      // Step 3: Reset password
      const newPassword = document.getElementById("new-password").value;
      const confirmPassword = document.getElementById("confirm-password").value;

      if (!newPassword || newPassword.length < 8) {
        showAlert("Password must be at least 8 characters.", "danger");
        return;
      }
      if (newPassword !== confirmPassword) {
        showAlert("Passwords do not match.", "danger");
        return;
      }

      const otpInput = document.getElementById("otp").value;

      const res = await postData("/reset-password", {
        email: userEmail,
        otp: otpInput,
        newPassword,
      });

      if (res.success) {
        showAlert("Password reset successful! You can now log in.", "success");
        form.reset();
        passwordSection.classList.add("hidden");
        emailSection.classList.remove("hidden");
        submitBtn.textContent = "Send Reset Link";
        currentStep = 1;
      } else {
        showAlert(res.message || "Error resetting password. Try again.", "danger");
      }
    }
  });

  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email.toLowerCase());
  }
</script>


</html>
